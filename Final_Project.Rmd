---
title: "Final_Project"
author: "Sylvia Brown, Pierina Forastieri, Julia Buschmann, Marlyn Bruno"
date: "2022-04-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

``` {r add-libraries}
library(tidyverse)
library(ipumsr)
library(srvyr)
library(haven)
```


```{r loading data}
ddi <- read_ipums_ddi("data/cps_00004.xml")
data <- read_ipums_micro(ddi) %>%
  janitor::clean_names()

cps_svy <- as_survey_design(data, weights = asecwtcvd)
# We use just the asecwtcvd weights because they are available for 2019-2021 ASECs (not just 2020)

asec_allyears <- cps_svy %>%
  filter(empstat != 1) %>% #filter out people in armed forces
  mutate(employed = case_when(
    empstat == 10 | empstat == 12 ~ 1,
    empstat == 21 | empstat == 22 ~ 0,
    TRUE ~ NA_real_
  )) %>%
  mutate_at(vars(offpov, himcarenw, caidnw, anycovly, prvtcovnw, grpcovnw, mrkcovnw, mrkscovnw, mrkucovnw, inhcovnw, sex), list(~ case_when(
    . == 2 ~ 1,
    . == 1 ~ 0,
    TRUE ~ NA_real_
  ))) %>%
  mutate(unitsstr = case_when(
    unitsstr == 00 ~ NA_real_,
    TRUE ~ as.numeric(unitsstr)
  )) %>%
  mutate(region = case_when(
    region == 97 ~ NA_real_,
    TRUE ~ as.numeric(region)
  )) %>%
  filter(statefip <= 56) %>% # drop weird multi-state fips codes
  mutate(metro = case_when(
    metro == 0 | metro >= 4 ~ NA_real_,
    TRUE ~ as.numeric(metro)
  )) %>%
  mutate(metarea = case_when(
    metarea >= 9997 ~ NA_real_,
    TRUE ~ as.numeric(metarea)
  )) %>%
  mutate(metfips = case_when(
    metfips >= 99998 ~ NA_real_,
    TRUE ~ as.numeric(metfips)
  )) %>%
  mutate(hhincome = case_when(
    hhincome == 9999999 ~ NA_real_,
    TRUE ~ as.numeric(hhincome)
  )) %>%
  mutate_at(vars(county, yrimmig, empstat, labforce, occ, classwly, ind, strechlk, whymove, disabwrk, paidgh), list(~ case_when(
    . == 0 ~ NA_real_,
    TRUE ~ as.numeric(.)
  ))) %>%
  mutate(wksunem1 = case_when(
    wksunem1 == 99 ~ NA_real_,
    TRUE ~ as.numeric(wksunem1)
  )) %>%
    mutate(educ = case_when(
    educ == 001 | educ == 999 ~ NA_real_,
    TRUE ~ as.numeric(educ)
  )) %>%
  mutate(wksunem2 = case_when(
    wksunem2 == 9 ~ NA_real_,
    TRUE ~ as.numeric(wksunem2)
  )) %>%
  mutate(ftotval = case_when(
    ftotval == 9999999999 ~ NA_real_,
    TRUE ~ as.numeric(ftotval)
  )) %>%
  mutate(inctot = case_when(
    inctot == 999999999 ~ NA_real_,
    TRUE ~ as.numeric(inctot)
  )) %>%
  mutate(incwelfr = case_when(
    incwelfr == 999999 ~ NA_real_,
    TRUE ~ incwelfr
  )) %>%
  mutate(incunemp = case_when(
    incunemp == 999999 ~ NA_real_,
    TRUE ~ as.numeric(incunemp)
  )) %>%
  mutate(ctccrd = case_when(
    ctccrd == 999999 ~ NA_real_,
    TRUE ~ as.numeric(ctccrd)
  )) %>%
  mutate(eitcred = case_when(
    eitcred == 9999 ~ NA_real_,
    TRUE ~ as.numeric(eitcred)
  )) %>%
  mutate(offpov = case_when(
    offpov == 99 ~ NA_real_,
    TRUE ~ as.numeric(offpov)
  )) %>%
  mutate(anycovly = case_when(
    anycovly == 99 ~ NA_real_,
    TRUE ~ as.numeric(anycovly)
  )) %>%
  mutate(immigrant = case_when(
    citizen == 1 ~ 1,
    citizen >= 2 & citizen <= 5 ~ 0,
    TRUE ~ NA_real_
  )) %>%
  select(-starts_with("q"), -asecwt, -month, -asecflag, -statecensus, -asecwth, -pernum, -cpsidp) # Drop quality flags and variables we don't need
  # NOTE: the 'immigrant' variable is 1 for people born in the U.S.; 0 for people born in the U.S. outlying territories (PR, Guam), people born abroad of American parents, naturalized citizens, and non-citizens; and NA for people marked as NIU.

# CONSIDER ADDING A STEP WHERE WE SAVE INDICATORS AS FACTORS

asec2019 <- asec_allyears %>%
  filter(year == 2019)

asec2020 <- asec_allyears %>%
  filter(year == 2020)

asec2021 <- asec_allyears %>%
  filter(year == 2021)

asec_allyears_imm <- asec_allyears %>%
  filter(immigrant == 1)

asec2019_imm <- asec2019 %>%
  filter(immigrant == 1)

asec2020_imm <- asec2020 %>%
  filter(immigrant == 1)

asec2021_imm <- asec2021 %>%
  filter(immigrant == 1)

# NOTE: FOR PCA, RECODE DUMMIES AS 0 AND SQRT(2)
  
```
